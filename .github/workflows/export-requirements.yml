name: Export requirements.txt

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths: ['poetry.lock']

jobs:
  export-requirements:
    name: Export requirements.txt
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        poetry_version: ['1.8.2']
        poetry_plugin_export_version: ['1.7']

    steps:
    - uses: actions/checkout@v4
    - name: Setup poetry ${{ matrix.poetry_version }}
      env:
        POETRY_VERSION: ${{ matrix.poetry_version }}
      run: pipx install poetry==$POETRY_VERSION
    - name: Inject poetry-plugin-export
      env:
        PLUGIN_VERSION: ${{ matrix.poetry_plugin_export_version }}
      run: pipx inject poetry poetry-plugin-export==$PLUGIN_VERSION
    - name: export requirements.txt
      run: poetry export -f requirements.txt --output requirements.txt
    - name: push changes
      uses: stefanzweifel/git-auto-commit-action@v5.0.0
      with:
        commit_message: "export requirements.txt"
        file_pattern: requirements.txt
